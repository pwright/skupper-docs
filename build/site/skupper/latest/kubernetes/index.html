<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Creating sites using a custom certificate authority on OpenShift :: Skupper PREVIEW</title>
    <link rel="canonical" href="https://skupper.io/docs/skupper/latest/kubernetes/index.html">
    <meta name="generator" content="Antora 3.1.2">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/search.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
    <nav class="navbar">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://skupper.io/docs">Skupper PREVIEW</a>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
                <a class="navbar-item" href="#">Home</a>



                <div class="navbar-item">
                    <span class="control">
                        <a class="button is-primary" href="#">Download</a>
                    </span>
                </div>
            </div>
        </div>
    </nav>
</header><div class="body">
<div class="nav-container" data-component="skupper" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Skupper</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Preview homepage</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../overview/index.html">Overview</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../overview/glossary.html">Glossary</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../cli/index.html">CLI</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli-reference/skupper.html">Kubernetes Reference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli-podman/skupper.html">Podman Reference</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../declarative/index.html">Declarative</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../policy/index.html">Policies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../console/index.html">Console 1.3 and later</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../cli/tokens.html">Tokens</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../troubleshooting/index.html">Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Kubernetes/OpenShift</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="index.html">Certs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kubernetes.html">Kubernetes tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gateway.html">Gateway tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operator/index.html">Kubernetes Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="service-certs.html">Encrypting traffic from a pod to the Skupper router</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Skupper</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Skupper</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Skupper</a></li>
    <li>Kubernetes/OpenShift</li>
    <li><a href="index.html">Certs</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///home/paulwright/repos/skupper-docs/modules/kubernetes/pages/index.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Creating sites using a custom certificate authority on OpenShift</h1>
<div class="paragraph">
<p>By default:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Network traffic between pods and the Skupper router is not encrypted. To encrypt traffic between pods and the Skupper router see <a href="service-certs.html" class="xref page">Encrypting traffic from a pod to the Skupper router</a>.</p>
</li>
<li>
<p>Skupper creates certificates to establish links between sites using mutual TLS.
This ensures that traffic between sites is encrypted.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These certificates are stored as secrets in the namespace when you create a site using <code>skupper init</code>.
If you want to use your own certificates, you can populate the a set of secrets with the appropriate certificates before creating the site as described in this section.
This set of secrets provides Skupper with the configuration required to create a site.</p>
</div>
<div class="paragraph">
<p>The following certificates are required:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">skupper-claims-server</dt>
<dd>
<p>Used for linking sites with claim type tokens.</p>
</dd>
<dt class="hdlist1">skupper-console-certs</dt>
<dd>
<p>Used by the Skupper console.</p>
</dd>
<dt class="hdlist1">skupper-local-client and skupper-local-server</dt>
<dd>
<p>Used by the Skupper router.</p>
</dd>
<dt class="hdlist1">skupper-site-server</dt>
<dd>
<p>Used for all inter-router connections, and for headless services.</p>
</dd>
<dt class="hdlist1">skupper-service-client</dt>
<dd>
<p>Used for services exposed over TLS.</p>
</dd>
</dl>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to an OpenShift cluster with sufficient permission to run <code>skupper init</code>.</p>
</li>
<li>
<p>Access to create certificates using your certificate authority.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create one or more certificates for a site.</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>There are several alternative approaches to this step:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reissue an existing certificate with a set of Subject Alternative Names (SANs) for the site.</p>
</li>
<li>
<p>Create a new certificate with a set of SANs for the site.</p>
</li>
<li>
<p>Create a new certificate for each item relating to the site.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You require a certificate for each of the following secrets:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>skupper.&lt;namespace&gt;</code></p>
</li>
<li>
<p><code>skupper-router.&lt;namespace&gt;</code></p>
</li>
<li>
<p><code>skupper-router-local</code></p>
</li>
<li>
<p><code>skupper-router-local.&lt;namespace&gt;.svc.cluster.local</code></p>
</li>
<li>
<p><code>claims-&lt;namespace&gt;.&lt;clustername&gt;.&lt;domain&gt;</code></p>
</li>
<li>
<p><code>skupper-&lt;namespace&gt;.&lt;clustername&gt;.&lt;domain&gt;</code></p>
</li>
<li>
<p><code>skupper-edge-&lt;namespace&gt;.&lt;clustername&gt;.&lt;domain&gt;</code></p>
</li>
<li>
<p><code>skupper-inter-router-&lt;namespace&gt;.&lt;clustername&gt;.&lt;domain&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;namespace&gt;</code> is the name of the namespace where you want to create a site.</p>
</li>
<li>
<p><code>&lt;clustername&gt;</code> is the name of the cluster.</p>
</li>
<li>
<p><code>&lt;domain&gt;</code> is the domain name for the cluster.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using a specific certificate authority technology is beyond the scope of this guide. However, the following commands show how to create a certificate authority on Linux and create a single certificate that you can use to populate the secrets.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create a <code>ca</code> directory and create a certificate authority certificate:</p>
<div class="listingblock">
<div class="content">
<pre>$ mkdir ca

$ cd ca

$ ssh-keygen -t rsa -m PEM -f tls.key -q -N ""
$ openssl req -x509 -nodes -days 365 -key tls.key -out tls.crt</pre>
</div>
</div>
</li>
<li>
<p>Given the certificate authority created <code>tls.crt</code> and <code>tls.key</code> files, you can create a certificate for the site as follows:</p>
<div class="listingblock">
<div class="content">
<pre>$ cd ..
$ mkdir certificate
$ cd certificate

$ openssl req -nodes -newkey rsa:4096 -x509 -CA ../ca/tls.crt -CAkey ../ca/tls.key -out tls.crt -keyout tls.key -addext "subjectAltName = DNS:skupper.&lt;namespace&gt;, DNS:skupper-router.&lt;namespace&gt;, DNS:skupper-router-local, DNS:skupper-router-local.&lt;namespace&gt;.svc.cluster.local,DNS:claims-&lt;namespace&gt;.&lt;clustername&gt;.&lt;domain&gt;, DNS:skupper-&lt;namespace&gt;.&lt;clustername&gt;.&lt;domain&gt;, DNS:skupper-edge-&lt;namespace&gt;.&lt;clustername&gt;.&lt;domain&gt;, DNS:skupper-inter-router-&lt;namespace&gt;.&lt;clustername&gt;.&lt;domain&gt;"</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You should now have a root certificate in the <code>ca</code> directory and another certificate in the <code>certificate</code> directory that you can use with a site.</p>
</div>
</div>
</div>
</li>
<li>
<p>Create secrets for the site</p>
<div class="openblock">
<div class="content">
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Change to the parent directory of the <code>certificate</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre>$ cd ..</pre>
</div>
</div>
</li>
<li>
<p>Populate the <code>ca</code> related secrets using the certificate from the <code>ca</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre>$ kubectl create secret tls skupper-site-ca --cert=ca/tls.crt --key=ca/tls.key

$ kubectl create secret tls skupper-service-ca --cert=ca/tls.crt --key=ca/tls.key

$ kubectl create secret tls skupper-local-ca --cert=ca/tls.crt --key=ca/tls.key</pre>
</div>
</div>
</li>
<li>
<p>Populate the other secrets and modify them into the format required by <code>skupper</code>:</p>
<div class="listingblock">
<div class="content">
<pre>$ kubectl create secret tls skupper-claims-server --cert=certificate/tls.crt --key=certificate/tls.key

$ kubectl patch secret skupper-claims-server  -p="{\"data\":{\"ca.crt\": \"$($ kubectl get secret skupper-site-ca -o json -o=jsonpath="{.data.tls\.crt}")\"}}"


$ kubectl create secret tls skupper-console-certs --cert=certificate/tls.crt --key=certificate/tls.key

$ kubectl patch secret skupper-console-certs  -p="{\"data\":{\"ca.crt\": \"$($ kubectl get secret skupper-local-ca -o json -o=jsonpath="{.data.tls\.crt}")\"}}"


$ kubectl create secret tls skupper-local-client --cert=certificate/tls.crt --key=certificate/tls.key

$ kubectl patch secret skupper-local-client  -p="{\"data\":{\"ca.crt\": \"$($ kubectl get secret skupper-local-ca -o json -o=jsonpath="{.data.tls\.crt}")\"}}"


$ kubectl create secret tls skupper-local-server --cert=certificate/tls.crt --key=certificate/tls.key

$ kubectl patch secret skupper-local-server  -p="{\"data\":{\"ca.crt\": \"$($ kubectl get secret skupper-local-ca -o json -o=jsonpath="{.data.tls\.crt}")\"}}"


$ kubectl create secret tls skupper-site-server --cert=certificate/tls.crt --key=certificate/tls.key

$ kubectl patch secret skupper-site-server  -p="{\"data\":{\"ca.crt\": \"$($ kubectl get secret skupper-site-ca -o json -o=jsonpath="{.data.tls\.crt}")\"}}"


$ kubectl create secret tls skupper-service-client --cert=certificate/tls.crt --key=certificate/tls.key

$ kubectl patch secret skupper-service-client  -p="{\"data\":{\"ca.crt\": \"$($ kubectl get secret skupper-service-ca -o json -o=jsonpath="{.data.tls\.crt}")\"}}"</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p>Create the site using the following command:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>$ skupper init</pre>
</div>
</div>
<div class="paragraph">
<p>On OpenShift, <code>skupper</code> defaults to use the <code>route</code> ingress, which is the equivalent of <code>skupper init --ingress route</code>.</p>
</div>
<div class="paragraph">
<p>To verify your site, check the status:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ skupper status</pre>
</div>
</div>
<div class="paragraph">
<p>You can also verify the OpenShift routes are created using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ oc get routes</pre>
</div>
</div>
<div class="paragraph">
<p>Finally, use the following command to check for errors relating to incorrect certificates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ skupper debug events</pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
